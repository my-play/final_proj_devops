name: Kubernetes Kind Setup

on:
  workflow_run:
    workflows: ["Terraform_Infrastructure_Setup"]
    types:
      - completed

jobs:
  install-kind:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Download workflow artifact
      uses: dawidd6/action-download-artifact@v2
      with:
        workflow: Terraform_Infrastructure_Setup
        run_id: ${{ github.event.workflow_run.id }}
        name: ec2-ip
        path: .

    - name: Read EC2 IP
      id: read-ip
      run: |
        if [ -f ec2_ip.txt ]; then
          echo "ec2_ip=$(cat ec2_ip.txt)" >> $GITHUB_OUTPUT
        else
          echo "Error: EC2 IP file not found"
          exit 1
        fi

    - name: SSH to EC2 and Install Kind
      run: |
        ssh -o StrictHostKeyChecking=no ec2-user@${{ steps.read-ip.outputs.ec2_ip }} << EOF 
        sudo yum update -y
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/latest/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin
        kind create cluster --name my-cluster
        EOF